---
title: "Workflow"
output: 
  html_document:
    toc: true
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---


```{r}
suppressPackageStartupMessages(library(tidyverse))
library(targets)
library(visNetwork)
```

```{r, eval = TRUE}
knitr::opts_knit$set(root.dir = "../../")
tar_unscript()
```


# Globals

```{targets globals, targets = FALSE}
options(tidyverse.quiet = TRUE)
tar_option_set(
  packages = c(
    "gt",
    "yardstick",
    "broom",
    "cowplot",
    "glue",
    "tidyverse",
    "arrow"
    )
  )
purrr::map(dir("./src/R", full.names = TRUE), source)
```

# Targets

## Config

```{targets config}
tar_target(
  config,
  list(
    # columns that are not features
    id_vars = c(
      'category_id',
      'modelling_category',
      'classification',
      'activity_id_new',
      'start_date',
      'index',
      'date_first_study_activity',
      'date_last_study_activity',
      'protocol',
      'file_name',
      'source_row_index',
      'audit_or_inspection',
      'site_platinum_id',
      'pi_platinum_id',
      'site_num',
      'country',
      'site_activation_date',
      'site_closed_date',
      'site_closed_date_corr',
      'study_start_date',
      'study_end_date'
     ),
     max_year = 2020
   )
)
```


## Data

### Files
```{targets, files}
list(
  tar_target(file_mm, "data/in/modelling_matrix.feather", format = "file"),
  tar_target(file_mm_bin, "data/in/lasso_prep.feather", format = "file"),
  tar_target(file_form, "data/in/glm_coefs.feather", format = "file"),
  tar_target(file_cv, "data/in/indeces_annual_splits.feather", format = "file"),
  tar_target(file_cat_lookup, "data/in/category_lookup.feather", format = "file"),
  tar_target(file_feat_lookup, "data/in/feature_lookup.csv", format = "file")
)
```

### Load

```{targets, load}
list(
  tar_target(df_mm, qract_read_and_anonymize(file_mm, config$id_vars, arrow::read_feather)),
  tar_target(df_mm_bin, qract_read_and_anonymize(file_mm_bin, config$id_vars, arrow::read_feather)),
  tar_target(df_form, qract_read_and_anonymize(file_form,  config$id_vars, arrow::read_feather)),
  tar_target(df_cv, qract_read_and_anonymize(file_cv,  config$id_vars, arrow::read_feather)),
  tar_target(df_cat_lookup, qract_read_and_anonymize(file_cat_lookup, config$id_vars, arrow::read_feather)),
  tar_target(df_feat_lookup, qract_read_and_anonymize(file_feat_lookup, config$id_vars, readr::read_csv))
)
```

## Time Series Cross Validation

```{targets, cv}
list(
  tar_target(p_tscv, qract_plot_tscv(df_mm, df_cv, config$max_year)),
  tar_target(df_cv_preds_and_coefs, qract_pred_cv(df_mm_bin, df_cv, df_form, config$id_vars))
)
```

## Performance

```{targets, perf}
list(
  tar_target(df_perf, qract_perf(df_cv_preds_and_coefs, config$max_year)),
  tar_target(df_calib, qract_lin_calib(df_cv_preds_and_coefs)),
  tar_target(df_bin, qract_bin_preds(df_cv_preds_and_coefs, n_bins = 4, confidence_level = .75)),
  tar_target(
    p_calib,
    qract_plot_calibration_pub(
      category_id_str = df_cv_preds_and_coefs$category_id %>% unique(),
      df_bin,
      df_calib,
      df_cat_lookup,
      uniform_color = "black",
      color_calib = "grey"
      )
  )
)
```

## Forest Plots

```{targets, forest}
tar_target(
  df_forest,
  qract_forest_plots(
    df_cv_preds_and_coefs,
    df_feat_lookup,
    df_mm,
    df_cat_lookup,
    category_ids = c(
      "cnsn",
      "dtin",
      "sfty",
      "ptpe"
    )
  )
)
```

# Run Workflow

```{r, make}
tar_make()
```


# Visualise Workflow

```{r, vis, fig.height=18, fig.width=12, eval = TRUE, include = TRUE}
tar_visnetwork()
```

